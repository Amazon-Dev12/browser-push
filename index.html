<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Browser Push by lahiiru</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-dark.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/main.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <header>
        <h1>Browser Push</h1>
        <p>Complete workout and guide lines to add web push notifications support for your webapp</p>
      </header>

      <div id="banner">
        <span id="logo"></span>

        <a href="https://github.com/lahiiru/browser-push" class="button fork"><strong>View On GitHub</strong></a>
        <div class="downloads">
          <span>Downloads:</span>
          <ul>
            <li><a href="https://github.com/lahiiru/browser-push/zipball/master" class="button">ZIP</a></li>
            <li><a href="https://github.com/lahiiru/browser-push/tarball/master" class="button">TAR</a></li>
          </ul>
        </div>
      </div><!-- end banner -->

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section>
        <h1>
<a id="push-notifications-for-your-webapp" class="anchor" href="#push-notifications-for-your-webapp" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Push notifications for your webapp!</h1>

<h2>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Introduction</h2>

<p>This repository contains and explains necessary steps to configure web push notifications for your webapp on Safari and <a href="https://w3c.github.io/push-api/">Push API</a> supported browsers as listed below: </p>

<ul>
<li>Chrome 49+</li>
<li>Firefox 52+</li>
<li>Opera 42+</li>
<li>
<p>Safari 10+</p>

<hr>

<p>This tutorial uses Java in Back-end and JavaScript in front-end. IntelliJ IDEA configured for Java, Maven and PHP is recommended to use for this tutorial. Source code can be downloaded from top of this site. The code is written for demonstration purpose and you have to learn and modify the code to use in your production environment.  Follow the steps below to configure web push notifications.</p>
</li>
</ul>

<h2>
<a id="what-is-a-web-push-notification" class="anchor" href="#what-is-a-web-push-notification" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>What is a web push notification?</h2>

<p><img src="https://github.com/lahiiru/browser-push/raw/gh-pages/pushondesk.png" alt="Push notification"></p>

<p><strong>Mobile push notifications</strong> can be sent from your back-end to some device owner's notification service such as Google's <a href="https://firebase.google.com/docs/cloud-messaging">FCM</a> or Apple's <a href="https://developer.apple.com/notifications">APNS</a>. Whenever the receiver device has the internet connectivity, pending messages are fetched from device owner's notification service and displayed to the user. To do this, your message recipient should have installed a push notification enabled mobile application given by you. <strong>Web push notifications</strong> or browser push notifications are somewhat different. Those are delivered to a web browser. Message recipient should have allowed notifications for your webapp or website by visiting the url from a push notification supported browser. It's the time for sending push notifications to your webapp visitors.</p>

<h2>
<a id="lets-start" class="anchor" href="#lets-start" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Let's start</h2>

<p>You can download the source code related to this tutorial from below or clicking the link at the top of this page. Feel free to contribute to the repository.</p>

<blockquote>
<p>Source code: <a href="https://github.com/lahiiru/browser-push">Browser-push</a></p>
</blockquote>

<p>If you are not willing to send notifications for Safari users, you can skip almost all the steps <g-emoji alias="smile" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f604.png" ios-version="6.0">ðŸ˜„</g-emoji>. Safari doesn't support <a href="https://w3c.github.io/push-api/">Push API</a> which is the W3C standard for web push notification protocol yet. But Chrome, Firefox and Opera latest versions has nicely done that. Therefore, we have to handle Safari separately while other all browsers can be considered as one. Let's say Safari and non-Safari.</p>

<hr>

<h2>
<a id="1-preparing-client-side-scripts" class="anchor" href="#1-preparing-client-side-scripts" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1. Preparing client-side scripts</h2>

<p>Open the project in IntelliJ IDEA.</p>

<h3>
<a id="guide-lines" class="anchor" href="#guide-lines" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Guide lines</h3>

<ol>
<li>Browse <code>front-end/keygen.html</code>. Generate and note down the keys.</li>
<li>Set <code>const applicationServerPublicKey</code> value<br>
in <code>front-end/sw.js</code> and <code>front-end/main.js</code> using generated server public key.</li>
<li>Now your client-side scripts are ready to test on non-safari browsers.</li>
<li>
<p>Open <code>front-end/index.html</code> in browser <strong>using any HTTP Server</strong>. You should be able to access to index.html from similar url as following.<br>
<code>http://localhost:65124/browser-push/front-end/index.html</code><br>
DNS should be <strong>localhost</strong>. Otherwise, it should be <strong>https://</strong><br>
Press <strong>Load script</strong> button then <strong>Enable Push Messaging</strong>. An input box will appear. Note down the JSON string from there as user subscription.</p>

<blockquote>
<p>This JSON object is called user subscription. In production environment, you should send this subscription to your backen-end and it should be persisted against some user identification. Later your back-end will use that user subscription objects to send push notifications to subscribed users. For demonstration purpose, you can copy it now and hard code in server code.</p>
</blockquote>
</li>
</ol>

<p><strong>If you need to send notifications to Safari browser, following additional steps are needed.</strong></p>

<ol>
<li>Create certificates (.p12 and .cer) and a website push id for your domain from Apple developer site. Refer <em>Registering with Apple</em> section in <a href="https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/NotificationProgrammingGuideForWebsites/PushNotifications/PushNotifications.html#//apple_ref/doc/uid/TP40013225-CH3-SW33">Configuring Safari Push Notifications</a> article.</li>
<li>
<p>Replace the <code>var domain</code> value in <code>front-end/main.js</code> with your website push id. It will look like <code>web.com.example</code></p>

<p>Then you need to setup a RESTful web service which will be called every time some Safari user is trying to subscribe for your webapp. Therefore, Safari push notification protocol needs 3 components to work together as following figure.</p>

<p><img src="https://github.com/lahiiru/browser-push/raw/gh-pages/handshake_2x.png" alt="Safari-handshake"></p>

<p>In above diagram, pink color box <em>Returns push package</em> needs to be done by our RESTful web service. <em>Push package</em> is a zip file which contains some files and it's hashes. Although Apple developer page instructs to build the <em>Push package</em> dynamically, in our implementation we will create it once and RESTful service will serve it as a static resource.</p>
</li>
<li>
<p>Navigate to <code>back-end/safari_push_package_creator/pushPackage.raw/</code>.<br>
Modify the files as you needed. Please refer the <em>Building the Push Package</em> section in <a href="https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/NotificationProgrammingGuideForWebsites/PushNotifications/PushNotifications.html#//apple_ref/doc/uid/TP40013225-CH3-SW7">Configuring Safari Push Notifications</a> article.</p>

<blockquote>
<p>If you are planing to add Safari push notification support to multiple domain names, specify those as <strong>"allowedDomains"</strong><br>
in <code>back-end/safari_push_package_creator/pushPackage.raw/website.json</code>.<br>
Parameter <strong>"webServiceURL"</strong> specifies the path where the Safari RESTful service will be deployed at. <strong>authenticationToken</strong> will be not using to identify users in our implementation. So keep it as it is. Further, you can have your own iconset.</p>
</blockquote>
</li>
<li><p>Set <code>$certificate_path, $certificate_password</code> variables<br>
in <code>back-end\safari_push_package_creator\index.php</code> to match your <em>.p12</em> certificate.</p></li>
<li>Run that php file.
<code>shell
&gt; php index.php
</code>
</li>
<li>Then a push package for your webapp will be created at following path<br>
back-end/safari_webservice_backend/binaries/push-package.zip`</li>
<li>Now make the <code>push-api.war</code> by packaging project <code>safari_webservice_backend</code>.
<code>shell
&gt; mvn package
</code>
</li>
<li>Deploy the <strong>push-api.war</strong> file in Tomcat or other container. After the deployment, <strong>"webServiceURL"</strong> specified in <strong>website.json</strong> should matches the context path of deployed web application.<br>
If everything works fine, 

<ul>
<li>
<code>http://webServiceURL/v1/</code> should response with <strong>BAD REQUEST</strong>
</li>
<li>
<code>http://pushPackages/v1/web.com.example</code> should download zip file <strong>push-package.bin</strong>.</li>
</ul>
</li>
<li>Now you can test Safari push notifications using <code>front-end/index.html</code>.</li>
<li>A confirmation box should be displayed when <strong>Load script</strong> button is clicked. Otherwise, check developer console outputs. If output is printed with <code>deviceToken=null</code>, this is a problem of your safari RESTful service or created push package. See push-api.war logs for troubleshooting.</li>
<li>
<p>If everything works fine, input box with device a should be appeared. Note down it as Safari subscription. It is needed when sending notifications.</p>

<blockquote>
<p>In production environment, you should send this subscription to your backen-end and it should be persisted against some user identification. Later your back-end will use that user subscription objects to send push notifications to subscribed users. For demonstration purpose, you can copy it now and hard code in server code.</p>
</blockquote>
</li>
</ol>

<h3>
<a id="references" class="anchor" href="#references" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>References</h3>

<p><strong>If you encounter any problem with above guide lines, following resources from the original authors will be helpful.</strong></p>

<ul>
<li>Architecture of the Push Framework is described in <a href="https://w3c.github.io/push-api">W3C draft</a>
</li>
<li>Architecture of the <a href="https://github.com/lahiiru/browser-push/raw/gh-pages/safari_notifs_rev_2x.png">Safari push notification framework</a>
</li>
<li>Original <a href="https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/NotificationProgrammingGuideForWebsites/CompanionFile.zip">createPushPackage.php</a> from developer.apple.com</li>
<li>Nice tutorial from Google, <a href="https://developers.google.com/web/fundamentals/getting-started/codelabs/push-notifications/">Push Codelab</a>
</li>
</ul>

<hr>

<h2>
<a id="2-sending-push-notifications-for-subscribed-users" class="anchor" href="#2-sending-push-notifications-for-subscribed-users" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2. Sending push notifications for subscribed users</h2>

<h3>
<a id="guide-lines-1" class="anchor" href="#guide-lines-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Guide lines</h3>

<ol>
<li>Navigate to <strong>universal_web_notification_sender</strong> project. Set previously generated (in Step 1.1) server keys in <code>PushServerVars.java</code>.</li>
<li>
<p>Add your subscriptions in <code>Sender.java</code> as follows.</p>

<div class="highlight highlight-source-java"><pre><span class="pl-smi">PushSubscription</span> nonSuffariSubscription <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">PushSubscription</span>( <span class="pl-s"><span class="pl-pds">"</span>subscriptionJson<span class="pl-pds">"</span></span> )
<span class="pl-smi">String</span> suffariSubscription <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>subscriptionToken<span class="pl-pds">"</span></span>;</pre></div>
</li>
<li>Sample notification should be delivered to your browser when you run <code>Sender.java</code> class.</li>
</ol>

<p><strong>If you need to send notifications to Safari browser, following additional steps are needed.</strong></p>

<ol>
<li>
<p>Place your <strong>.cer file</strong> (i.e apn_developer_identity.cer), <strong>.p12 file</strong> (i.e. private_dev_key.p12) and <strong>.certSigningRequest</strong> (i.e CertificateSigningRequest.certSigningRequest) in same directory and execute following commands to create <strong>apn_developer_identity.p12</strong>.</p>

<pre lang="dos"><code>openssl x509 -in apn_developer_identity.cer -inform DER -out apn_developer_identity.pem -outform PEM}
openssl pkcs12 -nocerts -out private_dev_key.pem -in private_dev_key.p12
openssl rsa -out private_key_noenc.pem -in private_dev_key.pem
openssl pkcs12 -export -in apn_developer_identity.pem -inkey private_key_noenc.pem -certfile CertificateSigningRequest.certSigningRequest -name "apn_developer_identity" -out apn_developer_identity.p12
</code></pre>
</li>
<li><p>Place your <strong>apn_developer_identity.p12</strong> in <strong>universal_web_notification_sender</strong> project root.</p></li>
<li>Change your certificate passkey in <code>private static void sendToSafari()</code> method in <code>Sender.java</code> class.</li>
<li>Uncomment <code>sendToSafari(safariSubscription, safariPayload);</code> line<br>
in <code>public static void main(String[] args)</code> method in <code>Sender.java</code> class.</li>
<li>Sample notification should be delivered to your Safari when you run <code>Sender.java</code> class.</li>
</ol>

<h3>
<a id="references-1" class="anchor" href="#references-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>References</h3>

<p><strong>If you encounter any problem with above guide lines, following resources from the original authors will be helpful.</strong></p>

<ul>
<li>
<a href="https://github.com/web-push-libs">web-push-libs</a>, <a href="https://github.com/MartijnDwars/web-push">MartijnDwars/web-push</a> for sending push notifications to non-Safari browsers.</li>
<li>
<a href="https://github.com/jpoz/APNS">jpoz/APNS</a> and <a href="https://github.com/notnoop/java-apns">notnoop/java-apns</a> for sending notifications to Safari.</li>
<li>Some online demo sites, <a href="https://gauntface.github.io/simple-push-demo/">simple-push-demo</a>, <a href="https://github.com/gauntface/simple-push-demo">simple-push-demo-repo</a>
</li>
<li>A free third party service does all of above things, <a href="https://onesignal.com">OneSignal</a>
</li>
</ul>
      </section>
      <footer>
        <p>Project maintained by <a href="https://github.com/lahiiru">lahiiru</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>
